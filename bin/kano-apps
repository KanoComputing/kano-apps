#!/usr/bin/env python

# kano-apps
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#

import os
import sys
import argparse
import json

if __name__ == '__main__' and __package__ is None:
    dir_path = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
    if dir_path != '/usr':
        sys.path = [dir_path] + sys.path

from kano_apps.AppManage import download_app, install_app, \
    install_link_and_icon
from kano.gtk3.scrolled_window import ScrolledWindow


def batch_install(apps, icon_only=False):
    for app in apps:
        app_data_file, app_icon_file = download_app(app)

        with open(app_data_file) as f:
            app_data = json.load(f)

        success = True
        if not icon_only:
            success = install_app(app_data, gui=False)

        if success:
            # write out the tmp json
            with open(app_data_file, "w") as f:
                f.write(json.dumps(app_data))

            install_link_and_icon(app_data["slug"], app_data_file,
                                  app_icon_file)


def args_parse():
    if len(sys.argv) >= 2:
        desc = "An application hub for Kano OS."
        parser = argparse.ArgumentParser(description=desc)
        parser.set_defaults(cmd=None)
        subparsers = parser.add_subparsers(dest="cmd")

        install_help = "Use this to install applications"
        install = subparsers.add_parser("install", help=install_help)

        install.add_argument("--no-gui", dest="gui", action="store_const",
                             const=False, default=True,
                             help="Run without the GUI")
        install.add_argument("--icon-only", dest="icon_only",
                             action="store_const", const=True, default=False,
                             help="Install just the app icon")
        install.add_argument("apps", metavar="APP", type=str, nargs="+",
                             help="A list of applications to install")

        return parser.parse_args()


def main():
    args = args_parse()
    if args is not None and args.cmd == "install":
        if args.gui:
            from gi.repository import Gtk
            from kano_apps.MainWindow import MainWindow

            win = MainWindow(install=args.apps, icon_only=args.icon_only)

            win.show_all()
            Gtk.main()
        else:
            batch_install(args.apps, icon_only=args.icon_only)
    else:
        # GTK is imported only if we're running in GUI mode
        from gi.repository import Gtk
        from kano_apps.MainWindow import MainWindow

        win = MainWindow()
        ScrolledWindow.apply_styling_to_screen(wide=True)
        win.show_all()
        Gtk.main()

    return 0

if __name__ == '__main__':
    sys.exit(main())
